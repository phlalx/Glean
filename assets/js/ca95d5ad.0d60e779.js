"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[345],{3905:function(e,n,t){t.r(n),t.d(n,{MDXContext:function(){return m},MDXProvider:function(){return p},mdx:function(){return f},useMDXComponents:function(){return c},withMDXComponents:function(){return s}});var a=t(67294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(){return r=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e},r.apply(this,arguments)}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function d(e,n){if(null==e)return{};var t,a,i=function(e,n){if(null==e)return{};var t,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var m=a.createContext({}),s=function(e){return function(n){var t=c(n.components);return a.createElement(e,r({},n,{components:t}))}},c=function(e){var n=a.useContext(m),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},p=function(e){var n=c(e.components);return a.createElement(m.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},h=a.forwardRef((function(e,n){var t=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,m=d(e,["components","mdxType","originalType","parentName"]),s=c(t),p=i,h=s["".concat(l,".").concat(p)]||s[p]||u[p]||r;return t?a.createElement(h,o(o({ref:n},m),{},{components:t})):a.createElement(h,o({ref:n},m))}));function f(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var r=t.length,l=new Array(r);l[0]=h;var o={};for(var d in n)hasOwnProperty.call(n,d)&&(o[d]=n[d]);o.originalType=e,o.mdxType="string"==typeof e?e:i,l[1]=o;for(var m=2;m<r;m++)l[m]=t[m];return a.createElement.apply(null,l)}return a.createElement.apply(null,t)}h.displayName="MDXCreateElement"},12038:function(e,n,t){t.d(n,{EO:function(){return o},O1:function(){return l},Rr:function(){return d}});var a,i=t(67294),r=t(44256);function l(e){return i.createElement("a",{href:a+e.file},e.file)}function o(e){return i.createElement("a",{href:a+e.file},e.children)}a=(0,r.isInternal)()?"https://www.internalfb.com/code/fbsource/fbcode/":"https://github.com/facebookincubator/Glean/tree/master/";var d=function(e){e.children;var n=e.internal,t=e.external;return(0,r.fbContent)({internal:i.createElement("code",null,n),external:i.createElement("code",null,t)})}},1554:function(e,n,t){t.r(n),t.d(n,{contentTitle:function(){return s},default:function(){return b},frontMatter:function(){return m},metadata:function(){return c},toc:function(){return p}});var a=t(87462),i=t(63366),r=(t(67294),t(3905)),l=t(44256),o=t(12038),d=["components"],m={id:"write",title:"Writing data to Glean",sidebar_label:"Writing data to Glean"},s=void 0,c={unversionedId:"write",id:"write",isDocsHomePage:!1,title:"Writing data to Glean",description:"This page describes the various ways in which data gets into Glean.",source:"@site/docs/write.md",sourceDirName:".",slug:"/write",permalink:"/docs/write",editUrl:"https://github.com/facebookincubator/Glean/tree/main/glean/website/docs/write.md",tags:[],version:"current",frontMatter:{id:"write",title:"Writing data to Glean",sidebar_label:"Writing data to Glean"},sidebar:"someSidebar",previous:{title:"Glean Databases",permalink:"/docs/databases"},next:{title:"Running the Tools",permalink:"/docs/running"}},p=[{value:"Client-driven writing",id:"client-driven-writing",children:[],level:2},{value:"Server-driven writing",id:"server-driven-writing",children:[],level:2},{value:"APIs for writing",id:"apis-for-writing",children:[],level:2},{value:"Writing from the command line",id:"writing-from-the-command-line",children:[{value:"JSON format",id:"json-format",children:[],level:3},{value:"Loading a DB from JSON in the shell",id:"loading-a-db-from-json-in-the-shell",children:[],level:3},{value:"Creating a database using the command line",id:"creating-a-database-using-the-command-line",children:[],level:3}],level:2}],u=function(e){return function(n){return console.warn("Component "+e+" was not imported, exported, or provided by MDXProvider as global scope"),(0,r.mdx)("div",n)}},h=u("Scribe"),f=u("Backup"),x={toc:p};function b(e){var n=e.components,t=(0,i.Z)(e,d);return(0,r.mdx)("wrapper",(0,a.Z)({},x,t,{components:n,mdxType:"MDXLayout"}),(0,r.mdx)("p",null,"This page describes the various ways in which data gets into Glean."),(0,r.mdx)(l.FbInternalOnly,{mdxType:"FbInternalOnly"},(0,r.mdx)("p",null,"For a complete walkthrough of the steps necessary to write an indexer, see ",(0,r.mdx)("a",{parentName:"p",href:"https://www.internalfb.com/intern/wiki/Glean/How_to:_write_a_Glean_indexer/"},"How to write a Glean indexer"),".")),(0,r.mdx)("p",null,"There are two main methods for creating a DB. Repo-wide indexing jobs\nwhich require multiple workers and have dependent tasks are managed by\nthe server, while simple one-off DB creation can be performed\nindependently by a single client."),(0,r.mdx)(l.FbInternalOnly,{mdxType:"FbInternalOnly"},(0,r.mdx)("p",null,"After the data is ingested by the write tier (",(0,r.mdx)("inlineCode",{parentName:"p"},"glean.write"),"), it is backed up and copied to the read tier (",(0,r.mdx)("inlineCode",{parentName:"p"},"glean"),") for efficient access. For newly created DB names, check out ",(0,r.mdx)("a",{parentName:"p",href:"https://www.internalfb.com/intern/wiki/Glean/Write/#configuring-db-backup-an"},"the section below")," for configuring this behavior.")),(0,r.mdx)("h2",{id:"client-driven-writing"},"Client-driven writing"),(0,r.mdx)("p",null,"A database can be created by a client using any of these methods:"),(0,r.mdx)("ol",null,(0,r.mdx)("li",{parentName:"ol"},"Programmatically, using one of the APIs listed in ",(0,r.mdx)("a",{parentName:"li",href:"#apis-for-writing"},"APIs for Writing"),"."),(0,r.mdx)("li",{parentName:"ol"},"On the command line: invoke the ",(0,r.mdx)("inlineCode",{parentName:"li"},"glean")," command-line tool to send data in JSON format, see ",(0,r.mdx)("a",{parentName:"li",href:"#creating-a-database-usin"}," Creating a database using the command line"),"."),(0,r.mdx)("li",{parentName:"ol"},"In the shell, use ",(0,r.mdx)("inlineCode",{parentName:"li"},"glean shell --db-root=<dir>")," and then use the command ",(0,r.mdx)("inlineCode",{parentName:"li"},":load")," to create a DB from a JSON file. See ",(0,r.mdx)("a",{parentName:"li",href:"#loading-a-db-from-json-i"}," Loading a DB from JSON in the shell"),".")),(0,r.mdx)(l.FbInternalOnly,{mdxType:"FbInternalOnly"},(0,r.mdx)("ol",{start:4},(0,r.mdx)("li",{parentName:"ol"},"Via Scribe, see ",(0,r.mdx)("a",{parentName:"li",href:"https://www.internalfb.com/intern/wiki/Glean/Write/#writing-data-using-scrib"},"Writing data using Scribe")))),(0,r.mdx)("h2",{id:"server-driven-writing"},"Server-driven writing"),(0,r.mdx)("p",null,"Large indexing jobs are coordinated by the server, using a ",(0,r.mdx)("em",{parentName:"p"},"recipe")," to\ndefine the various tasks and the dependencies between them.  Recipes\nare defined in the recipes configuration; see the ",(0,r.mdx)("inlineCode",{parentName:"p"},"--recipe-config"),"\noption in ",(0,r.mdx)("a",{parentName:"p",href:"/docs/running#common-options"},"Common options"),"."),(0,r.mdx)("p",null,"The job proceeds as follows:"),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("p",{parentName:"li"},"An indexing job is started by calling the server's ",(0,r.mdx)("inlineCode",{parentName:"p"},"kickOff")," Thrift\nmethod. This creates a work queue of tasks on the server.")),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("p",{parentName:"li"},"Clients obtain tasks from the server by calling ",(0,r.mdx)("inlineCode",{parentName:"p"},"getWork"),". Tasks may\nhave dependencies between them, so the server won't hand out a task\nuntil its dependencies are complete.")),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("p",{parentName:"li"},"When all tasks are done, the server marks the database as complete."))),(0,r.mdx)(l.FbInternalOnly,{mdxType:"FbInternalOnly"},(0,r.mdx)("p",null,"For the fbsource indexer, the components of this are:"),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},"The coordinator, run by a ",(0,r.mdx)("a",{parentName:"li",href:"https://www.internalfb.com/intern/chronos/job/?jobname=glean.clang.indexer&smc=chronos_gp_admin_client"},"chronos job"),", which calls ",(0,r.mdx)("inlineCode",{parentName:"li"},"kickoff")," and then waits for completion."),(0,r.mdx)("li",{parentName:"ul"},"The workers which poll the server (see ",(0,r.mdx)("a",{parentName:"li",href:"https://www.internalfb.com/intern/wiki/Glean/ClangIndexer/"},"Glean/ClangIndexer"),")"),(0,r.mdx)("li",{parentName:"ul"},"The server (see ",(0,r.mdx)("a",{parentName:"li",href:"https://www.internalfb.com/intern/wiki/Glean/Infrastructure/"},"Glean/Infrastructure"),")"))),(0,r.mdx)("h2",{id:"apis-for-writing"},"APIs for writing"),(0,r.mdx)(l.FbInternalOnly,{mdxType:"FbInternalOnly"},(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},"The C++ writing API is the most performant. It is used by the clang-based indexer for C++  and Objective C code.  See ",(0,r.mdx)("a",{parentName:"li",href:"https://phabricator.intern.facebook.com/diffusion/FBS/browse/master/fbcode/glean/cpp/glean.h"},"glean/cpp/glean.h")),(0,r.mdx)("li",{parentName:"ul"},"In Hack, ",(0,r.mdx)("a",{parentName:"li",href:"https://www.internalfb.com/intern/codex/symbol/php/Glean/genKickOffForHandle/"},"genKickOffForHandle")," and the various functions for writing facts."))),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},"The Haskell API for writing",(0,r.mdx)("ul",{parentName:"li"},(0,r.mdx)("li",{parentName:"ul"},"Example: ",(0,r.mdx)(o.O1,{file:"glean/client/hs/example/ExampleWriter.hs",mdxType:"SrcFile"}))))),(0,r.mdx)("p",null,"If none of the above work for you, the Thrift API enable basic write\naccess to the database."),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("inlineCode",{parentName:"li"},"kickOff")," can be used to create a new DB"),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("inlineCode",{parentName:"li"},"sendJsonBatch")," is for sending facts in JSON-serialized form"),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("inlineCode",{parentName:"li"},"finishBatch")," exposes the result of a previously sent JSON batch"),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("inlineCode",{parentName:"li"},"workFinished")," closes a DB")),(0,r.mdx)("p",null,"A rough outline of a client looks like:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre"},"glean = make_glean_thrift_client()\ndb_handle = make_uuid()\nglean.kickOff(my_repo, KickOffFill(writeHandle=db_handle))\nfor json_batch in json_batches:\n    handle = glean.sendJsonBatch(json_batch)\n    result = glean.finishBatch(handle)\n    # handle result\nglean.workFinished(my_repo, db_handle, success_or_failure)\n")),(0,r.mdx)("h2",{id:"writing-from-the-command-line"},"Writing from the command line"),(0,r.mdx)("h3",{id:"json-format"},"JSON format"),(0,r.mdx)("p",null,"The JSON format for Glean data is described in ",(0,r.mdx)("a",{parentName:"p",href:"/docs/schema/thrift"},"Thrift and JSON"),"."),(0,r.mdx)("p",null,"Here's an example of JSON data for writing to Glean:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre"},'[\n  { "predicate": "cxx1.Name.1",          # define facts for cxx1.Name.1\n    "facts": [\n      { "id": 1, "key": "abc" },         # define a fact with id 1\n      { "id": 2, "key": "def" }\n    ]\n  },\n  { "predicate": "cxx1.FunctionName.1",  # define facts for cxx1.FunctionName.1\n    "facts": [\n      { "id": 3,\n        "key": {\n          "name": { "id": 1 }}}          # reference to fact with id 1\n    ]\n  },\n  { "predicate": "cxx1.FunctionQName.1", # define facts for cxx1.FunctionQName.1\n    "facts": [\n      { "key": {\n        "name": 3,                       # 3 is shorthand for { "id": 3 }\n        "scope": { "global_": {} } } },\n      { "key": {\n        "name": {\n          "key": {                       # define a nested fact directly\n            "name": {\n              "key": "ghi" }}},         # another nested fact\n        "scope": {\n          "namespace_": {\n            "key": {\n              "name": {\n                "key": "std" }}}}}\n    ]\n  }\n]\n')),(0,r.mdx)("p",null,"The rules of the game are:"),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},"Predicate names must include versions, i.e. ",(0,r.mdx)("inlineCode",{parentName:"li"},"cxx1.Name.1")," rather than ",(0,r.mdx)("inlineCode",{parentName:"li"},"cxx1.Name"),"."),(0,r.mdx)("li",{parentName:"ul"},"The ",(0,r.mdx)("inlineCode",{parentName:"li"},"id")," field when defining a fact is optional. The ",(0,r.mdx)("inlineCode",{parentName:"li"},"id")," numbers in the input file will ",(0,r.mdx)("em",{parentName:"li"},"not")," be the final ",(0,r.mdx)("inlineCode",{parentName:"li"},"id")," numbers assigned to the facts in the database."),(0,r.mdx)("li",{parentName:"ul"},"There are no restrictions on ",(0,r.mdx)("inlineCode",{parentName:"li"},"id")," values (any 64-bit integer will do) but an ",(0,r.mdx)("inlineCode",{parentName:"li"},"id")," value may not be reused within a file."),(0,r.mdx)("li",{parentName:"ul"},"Later facts may refer to earlier ones using either ",(0,r.mdx)("inlineCode",{parentName:"li"},'{ "id": N }')," or just ",(0,r.mdx)("inlineCode",{parentName:"li"},"N"),"."),(0,r.mdx)("li",{parentName:"ul"},"It is only possible to refer to ",(0,r.mdx)("inlineCode",{parentName:"li"},"id"),"s from facts in the same file, if you are writing multiple files using ",(0,r.mdx)("inlineCode",{parentName:"li"},"glean write")," or via the ",(0,r.mdx)("inlineCode",{parentName:"li"},"sendJsonBatch")," API."),(0,r.mdx)("li",{parentName:"ul"},"a nested facts can be defined inline, instead of defining it with an ",(0,r.mdx)("inlineCode",{parentName:"li"},"id")," first and then referencing it."),(0,r.mdx)("li",{parentName:"ul"},"an inline nested fact can be given an ",(0,r.mdx)("inlineCode",{parentName:"li"},"id")," and referred to later.")),(0,r.mdx)("h3",{id:"loading-a-db-from-json-in-the-shell"},"Loading a DB from JSON in the shell"),(0,r.mdx)("p",null,"The shell is useful for experimenting with creating a DB from JSON data directly. Let's try loading the data above into a DB in the shell:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre"},"$ mkdir /tmp/glean\n$ glean shell --db-root /tmp/glean\nGlean Shell, dev mode\ntype :help for help.\nno fbsource database availabe\n> :load test/0 /home/smarlow/test\nI0514 01:19:37.137109 3566745 Work.hs:184] test/16: database complete\n")),(0,r.mdx)("p",null,"Let's see what facts we loaded:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre"},"test> :stat\n1\n  count: 72\n  size:  5988\ncxx1.FunctionName.1\n  count: 2\n  size:  66\ncxx1.FunctionQName.1\n  count: 2\n  size:  70\ncxx1.Name.1\n  count: 4\n  size:  148\ncxx1.NamespaceQName.1\n  count: 1\n  size:  35\ntest>\n")),(0,r.mdx)("p",null,"Note that there were 4 ",(0,r.mdx)("inlineCode",{parentName:"p"},"cxx1.Name.1")," facts - some of those were defined as inline nested facts in the JSON. We can query them all:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre"},'test> cxx1.Name _\n4 results, 1 queries, 4 facts, 0.22ms, 44296 bytes\n\n{ "id": 1096, "key": "abc" }\n{ "id": 1097, "key": "def" }\n{ "id": 1100, "key": "ghi" }\n{ "id": 1102, "key": "std" }\n')),(0,r.mdx)("p",null,"Note that the ",(0,r.mdx)("inlineCode",{parentName:"p"},"id")," values here do not correspond to the ",(0,r.mdx)("inlineCode",{parentName:"p"},"id")," values in the input file."),(0,r.mdx)("h3",{id:"creating-a-database-using-the-command-line"},"Creating a database using the command line"),(0,r.mdx)("p",null,"The ",(0,r.mdx)("inlineCode",{parentName:"p"},"glean")," command-line tool can be used to create a database directly on the server."),(0,r.mdx)(l.FbInternalOnly,{mdxType:"FbInternalOnly"},(0,r.mdx)("p",null,"There is a default retention policy for databases created this way; for details and to discuss your requirements, talk to the Glean team before creating databases.")),(0,r.mdx)("p",null,"To create a database from a single file of JSON facts:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre"},"glean create --service <write-server> --finish --repo <name>/<hash> <filename>\n")),(0,r.mdx)("p",null,"where"),(0,r.mdx)(l.FbInternalOnly,{mdxType:"FbInternalOnly"},(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("inlineCode",{parentName:"li"},"<write-server>")," can be ",(0,r.mdx)("inlineCode",{parentName:"li"},"glean.write.test")," for testing. ",(0,r.mdx)("inlineCode",{parentName:"li"},"glean.write")," is the production write tier."))),(0,r.mdx)(l.OssOnly,{mdxType:"OssOnly"},(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("inlineCode",{parentName:"li"},"<write-server>")," is the ",(0,r.mdx)("inlineCode",{parentName:"li"},"host:port")," of the Glean server"))),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("inlineCode",{parentName:"li"},"<name>")," is the name for your DB. For indexing repositories we normally use the name of the repository, but it's just a string, so you can use whatever you want."),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("inlineCode",{parentName:"li"},"<hash>")," identifies this particular instance of your database. For repositories we normally use the revision hash, but, again, it's just a string."),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("inlineCode",{parentName:"li"},"<filename>")," the file containing the JSON facts.")),(0,r.mdx)("p",null,"If the file is more than, say, 100MB, this operation will probably time out sending the data to the server. To send large amounts of data you need to batch it up into multiple files, and then send it like this:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre"},"glean create --service <write-server> --repo <name>/<hash>\nglean write --service <write-server> --repo <name>/<hash> <filename1>\nglean write --service <write-server> --repo <name>/<hash> <filename2>\n...\nglean finish --service <write-server> --repo <name>/<hash>\n")),(0,r.mdx)("p",null,"To find out if your DB made it:"),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre"},"glean shell --service <write-server> :list\n")),(0,r.mdx)("p",null,"This will list the DBs available on the write server."),(0,r.mdx)(h,{mdxType:"Scribe"}),(0,r.mdx)(f,{mdxType:"Backup"}))}b.isMDXComponent=!0}}]);